@model HotelReservation.Models.Room
@inject HotelReservation.Services.ICurrencyService CurrencyService
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer
@{
    ViewData["Title"] = Model.RoomType;

    string checkInDateString = Context.Request.Query["checkInDate"];
    string checkOutDateString = Context.Request.Query["checkOutDate"];
    string guestCountString = Context.Request.Query["guestCount"];
}

<div class="container mt-4">
    <div class="row">
        <div class="col-lg-7 mb-4">
            <div class="card shadow-sm">
                <img src="@Model.ImageUrl" class="img-fluid rounded" alt="@Model.RoomType">
            </div>
        </div>
        <div class="col-lg-5">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h2 class="card-title">@Model.RoomType</h2>
                    <hr />
                    <p class="card-text text-muted">@Model.Description</p>

                    <ul class="list-group list-group-flush my-3">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <strong>@Localizer["Capacity"]</strong>
                            <span>@Model.Capacity</span>
                        </li>
                        @{
                            // 1. O anki para birimini cookie'den oku (varsayılan TRY)
                            var targetCurrency = Context.Request.Cookies["UserCurrency"] ?? "TRY";

                            // 2. Fiyatı CurrencyService kullanarak dönüştür
                            var convertedPrice = await CurrencyService.ConvertFromTRYAsync(Model.PricePerNight, targetCurrency);

                            // 3. Fiyatı, hedef para birimine uygun kültürle (formatla)
                            var targetCulture = CurrencyService.GetCultureInfoForCurrency(targetCurrency);
                        }
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <strong>@Localizer["PricePerNight"]</strong>
                            <span class="fs-5 fw-bold text-success">@convertedPrice.ToString("C", targetCulture)</span>
                        </li>

                        <h5 class="mt-4">@Localizer["FeaturedAmenities"]</h5>
                    </ul>
                    @if (Model.Amenities != null && Model.Amenities.Any())
                    {
                        <ul class="list-group list-group-flush mb-3">
                            @foreach (var amenity in Model.Amenities)
                            {
                                <li class="list-group-item d-flex align-items-center">

                                    <i class="@amenity.IconClass text-success me-2 fs-5"></i>

                                    <span>@amenity.Name</span>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="text-muted small">@Localizer["NoAmenitiesSpecified"]</p>
                    }

                    <div class="row mt-5">
                        <div class="col-12">
                            <h3 class="mb-3">
                                Misafir Yorumları
                                @if (ViewBag.ReviewCount > 0)
                                {
                                    <span class="badge bg-warning text-dark ms-2" style="font-size: 1rem;">
                                        ★ @(((double)ViewBag.AverageRating).ToString("0.0"))
                                        (@ViewBag.ReviewCount Yorum)
                                    </span>
                                }
                            </h3>
                            <hr />

                            @if (Model.Reviews == null || !Model.Reviews.Any())
                            {
                                <div class="alert alert-info">Bu oda için henüz yorum yapılmamış.</div>
                            }
                            else
                            {
                                @foreach (var review in Model.Reviews.OrderByDescending(r => r.DatePosted))
                                {
                                    <div class="card mb-3 shadow-sm">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between">
                                                <strong>@review.User.FullName</strong> <span class="text-muted">@review.DatePosted.ToShortDateString()</span>
                                            </div>

                                            <div class="text-warning mb-2">
                                                @for (int i = 1; i <= 5; i++)
                                                {
                                                    <i class="bi @(i <= review.Rating ? "bi-star-fill" : "bi-star")"></i>
                                                }
                                            </div>

                                            <p class="card-text">@review.Comment</p>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <a asp-controller="Reservations" asp-action="Create"
                           asp-route-roomId="@Model.Id"
                           asp-route-checkInDate="@checkInDateString"
                           asp-route-checkOutDate="@checkOutDateString"
                           class="btn btn-success btn-lg">
                            <i class="bi bi-calendar-check"></i> @Localizer["ReserveForSelectedDates"]
                        </a>

                        @* Geri Dönme Linki (Arama sonuçlarına) *@
                        <a asp-controller="Rooms" asp-action="Search"
                           asp-route-checkInDate="@checkInDateString"
                           asp-route-checkOutDate="@checkOutDateString"
                           asp-route-guestCount="@guestCountString"
                           class="btn btn-secondary mt-2">
                            <i class="bi bi-arrow-left"></i> @Localizer["BackToSearchResults"]
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>