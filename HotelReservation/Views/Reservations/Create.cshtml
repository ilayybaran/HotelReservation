@model HotelReservation.Models.Reservation
@inject HotelReservation.Services.ICurrencyService CurrencyService
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer
@{
    ViewData["Title"] = "Rezervasyonu Onayla";
    var nights = (Model.CheckOutDate > Model.CheckInDate)
        ? (Model.CheckOutDate - Model.CheckInDate).Days
        : 0;
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header bg-success text-white py-3 rounded-top-4">
                    <h4 class="mb-0 text-center fw-bold">@Localizer["Reservation Details"]</h4>
                </div>

                <div class="card-body p-4">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                       @{
                            // 1. O anki para birimini cookie'den oku (varsayılan TRY)
                            var targetCurrency = Context.Request.Cookies["UserCurrency"] ?? "TRY";

                            // 2. Fiyatı CurrencyService kullanarak dönüştür
                            var convertedPrice = await CurrencyService.ConvertFromTRYAsync(Model.Room.PricePerNight, targetCurrency);

                            var convertedTotalPrice = await CurrencyService.ConvertFromTRYAsync(Model.TotalPrice, targetCurrency);

                            // 3. Fiyatı, hedef para birimine uygun kültürle (formatla)
                            var targetCulture = CurrencyService.GetCultureInfoForCurrency(targetCurrency);
                        }

                    @if (Model.Room != null)
                    {
                        <div class="row align-items-center mb-4">
                            <div class="col-md-5">
                                <img src="@Model.Room.ImageUrl"
                                     alt="@Model.Room.RoomType"
                                     class="img-fluid rounded-3 shadow-sm"
                                     style="object-fit: cover; height: 230px; width: 100%;">
                            </div>

                            <div class="col-md-7">
                                <h4 class="fw-bold">@Model.Room.RoomType</h4>
                                <p class="text-muted small">@Model.Room.Description</p>

                                <ul class="list-unstyled small">
                                    <li><strong>Kapasite:</strong> @Model.Room.Capacity Kişi</li>
                                 
                                    <li><span class="fs-5 fw-bold text-success">@convertedPrice.ToString("C", targetCulture)</span></li>
                                </ul>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning text-center">@Localizer["FailToLoad"]</div>
                    }

                    <hr />

                    <h5 class="mb-3 fw-bold text-success">Konaklama Bilgileri</h5>

                    <form asp-action="Create" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="RoomId" />

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="CheckInDate" class="form-label fw-semibold">@Localizer["CheckInDate"]</label>
                                <input asp-for="CheckInDate" type="date" class="form-control" readonly />
                            </div>
                            <div class="col-md-6">
                                <label asp-for="CheckOutDate" class="form-label fw-semibold">@Localizer["CheckOutDate"]</label>
                                <input asp-for="CheckOutDate" type="date" class="form-control" readonly />
                            </div>
                        </div>

                        <div class="p-3 rounded-3" style="background-color: #f9f9f9;">
                            <h6 class="fw-bold mb-2">@Localizer["Summary"]</h6>
                            @if (nights > 0)
                            {
                                <p class="mb-1"><strong>@Localizer["Duration"]:</strong> @nights Gece</p>
                                <p class="mb-0">
                                    <strong>Toplam Tutar:</strong>
                                    <span class="text-success fw-bold fs-5">@convertedTotalPrice.ToString("C", targetCulture)</span>
                                    
                                </p>
                            }
                            else
                            {
                                <p class="text-danger mb-0">@Localizer["InvalidRage"]</p>
                            }
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-success btn-lg fw-semibold" @(nights <= 0 ? "disabled" : "")>
                                @Localizer["CompleteReservation"]
                            </button>
                            <button type="submit" class="btn btn-success btn-lg fw-semibold" asp-action="CreateAndPay">
                                @Localizer["Pay"]</button>
                            <a asp-controller="Rooms" asp-action="Details" asp-route-id="@Model.RoomId" class="btn btn-outline-secondary">
                               @Localizer["BacktoRoomDetails"]
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
